#!/usr/bin/env ruby

require 'bundler/setup'
require 'metasploit/aggregator'
require 'metasploit/aggregator/cable'
require 'metasploit/aggregator/logger'

admin_host = '127.0.0.1'
admin_port = 2447
listener = '127.0.0.1'
remote_console = '127.0.0.1'
# cert_file = './cert.pem'
# cert_string = File.new(cert_file).read
cert_string = nil

# server = Metasploit::Aggregator::Server.new('127.0.0.1', 1337)
server = Metasploit::Aggregator::MsgPackServer.new(admin_host, admin_port)
server.start
Logger.log "Starting administration service on #{admin_host}:#{admin_port}"

loop do
  command = $stdin.gets
  if command.chomp == 'exit'
    exit
  elsif command.chomp == 'clear'
    forwarder.requests = []
    forwarder.responses = []
  elsif command.chomp == 'pause'
    Logger.log "paused"
  elsif command.chomp == 'start'
    server.start
  elsif command.chomp == 'stop'
    server.stop
  elsif command.chomp == 'park'
    client.release_session($stdin.gets.chomp)
  end
end
